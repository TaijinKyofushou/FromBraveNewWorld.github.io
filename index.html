<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡ªæ–°ä¸–ç•Œ - From Brave New World</title>
    <style>
        :root {
            /* é»˜è®¤ä¸»é¢˜ï¼Œä¼šè¢«JSONè¦†ç›– */
            --bg-base: #f5f5f5;
            --bg-hot: #e0e0e0;
            --text-color: #1a1a1a;
            --accent-color: #333333;
            --heat-color: #555555;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-base);
            color: var(--text-color);
            font-family: "Songti SC", "Noto Serif SC", serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 2s ease;
            user-select: none;
        }

        /* è§†è§‰ç‰¹æ•ˆå±‚ */
        #vignette-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            box-shadow: inset 0 0 0px rgba(0, 0, 0, 0);
            pointer-events: none; z-index: 5;
            transition: box-shadow 1s ease; mix-blend-mode: multiply;
        }
        #noise {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 2; opacity: 0.06;
            background-image: url('data:image/svg+xml;utf8,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)"/%3E%3C/svg%3E');
        }

        /* é¡¶éƒ¨UI */
        #top-ui {
            position: fixed; top: 0; left: 0; width: 100%;
            padding: 20px; box-sizing: border-box; z-index: 100;
            display: flex; flex-direction: column; gap: 2px;
            opacity: 0; transition: opacity 1s; pointer-events: none;
        }
        #timeline-container {
            width: 100%; max-width: 800px; margin: 0 auto;
            display: flex; align-items: center; gap: 10px;
            font-size: 0.7rem; color: #999;
        }
        #timeline-bar { flex-grow: 1; height: 2px; background: rgba(0,0,0,0.1); position: relative; }
        #timeline-progress {
            position: absolute; left: 0; top: 0; height: 100%; width: 0%;
            background: var(--text-color); transition: width 0.5s ease;
        }
        #time-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-family: 'Courier New', 'Consolas', 'Monaco', monospace;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(0,0,0,0.4), 0 0 3px rgba(0,0,0,0.2);
            letter-spacing: 2px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0;
            z-index: 101;
            width: auto;
            max-width: 800px;
        }
        #time-heat-container {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            margin-bottom: 0;
            margin-top: 50px;
        }
        .time-char {
            display: inline-block;
            position: relative;
            overflow: hidden;
            height: 1.2em;
            line-height: 1.2em;
            vertical-align: top;
        }
        .time-char-inner {
            display: inline-block;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .time-char.animate .time-char-inner {
            animation: timeRoll 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes timeRoll {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            50% {
                transform: translateY(-1.2em);
                opacity: 0.3;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        #heat-display {
            display: flex; align-items: center; justify-content: flex-end;
            gap: 10px; font-size: 0.8rem; color: var(--accent-color);
        }
        #heat-bar-bg {
            width: 80px; height: 6px; background: rgba(0,0,0,0.05);
            border-radius: 3px; overflow: hidden;
        }
        #heat-bar-fill {
            height: 100%; width: 0%; background: var(--heat-color);
            transition: width 0.5s ease;
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        #control-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 15px; background: linear-gradient(to top, var(--bg-base) 80%, transparent);
            z-index: 150; display: flex; justify-content: center; gap: 20px;
            opacity: 0; transition: opacity 0.5s; 
        }
        .control-btn {
            background: transparent; border: 1px solid #ccc;
            color: #666; padding: 5px 15px; font-size: 0.8rem;
            cursor: pointer; border-radius: 20px; font-family: inherit;
            transition: all 0.2s;
        }
        .control-btn:hover:not(:disabled) {
            border-color: var(--accent-color); color: var(--accent-color);
            background: rgba(255,255,255,0.5);
        }
        .control-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .shortcut-hint { font-size: 0.7rem; opacity: 0.5; margin-left: 5px; }

        /* ä¸»å®¹å™¨ */
        #game-container {
            position: relative; width: 100%; max-width: 700px; height: 80vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 10; padding: 20px; box-sizing: border-box;
        }
        #text-area {
            font-size: 1.2rem; line-height: 2; text-align: left;
            width: 100%; min-height: 250px; margin-top: 20px; margin-bottom: 30px;
            opacity: 0; transform: translateY(20px);
            transition: opacity 0.5s, transform 0.5s;
        }
        .speaker {
            font-size: 1.5rem; color: var(--accent-color); margin-bottom: 15px;
            font-weight: 700; display: block; letter-spacing: 2px;
            border-left: 3px solid var(--accent-color); padding-left: 10px;
        }
        .system-text { color: #666; font-style: italic; font-size: 1.1rem; }
        #choices-area {
            display: flex; flex-direction: column; width: 100%; gap: 15px;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .choice-btn {
            background: rgba(255,255,255,0.8); border: 1px solid #dcdcdc;
            padding: 15px 20px; font-family: inherit; font-size: 1.1rem;
            color: var(--text-color); cursor: pointer; transition: all 0.3s ease;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .choice-btn:hover {
            background: #fff; border-color: var(--accent-color);
            color: var(--accent-color); letter-spacing: 1px;
            transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        #continue-hint {
            position: absolute; bottom: 80px; font-size: 0.8rem; color: #aaa;
            animation: blink 2s infinite; pointer-events: none; display: none;
        }

        /* èœå•ç•Œé¢ */
        #start-screen, #achievement-screen, #ng-plus-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-base); z-index: 300;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }

        /* ä¸»é¡µæ ‡é¢˜è®¾è®¡ */
        .title-container {
            margin-bottom: 60px;
            text-align: center;
            position: relative;
        }
        
        .title-main {
            font-size: 5rem; 
            font-weight: 900;
            color: var(--text-color);
            line-height: 0.9;
            margin: 0;
            text-shadow: none; 
            letter-spacing: -2px; 
            z-index: 2;
            position: relative;
        }

        .title-sub {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 1.2rem;
            letter-spacing: 1rem; 
            color: var(--accent-color);
            margin-top: 10px;
            font-weight: 300;
            text-transform: uppercase;
            margin-left: 1rem; 
            animation: heat-shimmer 4s infinite alternate ease-in-out;
            opacity: 0.8;
        }

        @keyframes heat-shimmer {
            0% { letter-spacing: 1rem; opacity: 0.7; filter: blur(0px); }
            100% { letter-spacing: 1.2rem; opacity: 1; filter: blur(0.5px); }
        }

        .credits { font-size: 0.8rem; color: #999; margin-bottom: 30px; letter-spacing: 2px; }
        
        .menu-btn {
            padding: 10px 30px; 
            border: none; 
            border-bottom: 2px solid #333;
            background: transparent; 
            font-family: inherit; 
            font-size: 1.1rem;
            cursor: pointer; 
            margin: 12px; 
            transition: all 0.3s;
            position: relative;
        }
        /* ä¸»é¡µæ¸¸æˆæ§åˆ¶æŒ‰é’®ï¼šç»Ÿä¸€ç«–å‘å±…ä¸­æ’åˆ— */
        #game-controls .menu-btn {
            display: block;
            margin: 10px auto;
        }
        .menu-btn:hover {
            letter-spacing: 4px; border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        #continue-btn {
            border-bottom: 2px solid var(--accent-color);
            font-weight: bold;
        }

        .danger-btn {
            font-size: 0.8rem; color: #bbb; border-bottom: 1px dashed #ccc;
            margin-top: 50px;
        }
        .danger-btn:hover { color: red; border-color: red; letter-spacing: 1px; }

        /* æ–‡ä»¶ä¸Šä¼ éšè— */
        #file-input { display: none; }

        /* ç»“å±€åˆ—è¡¨ */
        .achievement-list {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; max-width: 800px; width: 90%; margin-bottom: 30px;
            text-align: center; overflow-y: auto; max-height: 60vh;
        }
        .ach-item {
            padding: 15px; border: 1px solid #e0e0e0; color: #ccc;
            background: #fff; font-size: 0.9rem;
        }
        .ach-item.unlocked {
            color: #333; border-color: var(--accent-color); background: #fffafa;
        }
        
        /* Segmentæˆå°±åˆ—è¡¨ */
        .segment-achievement-list {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px; 
            max-width: 800px; 
            width: 90%; 
            margin-bottom: 30px;
            text-align: left; 
            overflow-y: auto; 
            max-height: 60vh;
        }
        .segment-ach-item {
            padding: 15px; 
            border: 1px solid #e0e0e0; 
            color: #333;
            background: #fff; 
            font-size: 0.9rem; 
            border-radius: 4px;
            display: flex; 
            flex-direction: column; 
            gap: 8px;
        }
        .segment-ach-item .ach-time {
            font-size: 0.8rem; 
            color: #666; 
            font-weight: normal;
        }
        .segment-ach-item .ach-name {
            font-size: 1rem; 
            font-weight: bold; 
            color: var(--accent-color);
            text-align: left;
        }
        #ending-detail-title {
            font-size: 1.6rem;
            font-weight: bolder;
            color: var(--accent-color);
            text-align: center;
            margin-top: 10px;
            margin-bottom: 30px;
        }
        .segment-ach-item .ach-description {
            font-size: 0.85rem; 
            color: #555; 
            line-height: 1.4;
        }
        
        /* æˆå°±å¼¹çª— */
        #achievement-toast {
            position: fixed; bottom: 20px; left: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            color: var(--text-color);
            padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-size: 0.95rem; max-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            opacity: 0; transition: opacity 0.3s ease;
            pointer-events: none;
        }
        #achievement-toast.show {
            opacity: 1;
        }
        
        /* å…¨æˆå°±å¼¹çª—æ ·å¼ */
        #full-achievement-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            color: var(--text-color);
            padding: 20px 30px; border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            font-family: "Songti SC", "Noto Serif SC", serif;
            font-size: 1.2rem; font-weight: bold; max-width: 500px; text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
            opacity: 0; transition: opacity 0.5s ease;
            pointer-events: none;
        }
        #full-achievement-toast.show {
            opacity: 1;
        }
        
        /* Segmentæˆå°±é¡µé¢ */
        #segment-achievement-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-base); z-index: 300;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        /* å…¨æˆå°±å¥–åŠ±æ–‡æœ¬ç•Œé¢ & ç»“å±€è¯¦æƒ…ç•Œé¢ */
        #full-achievement-reward-screen,
        #ending-detail-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-base); z-index: 400;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        #reward-text-area,
        #ending-detail-text-area {
            font-size: 1rem; 
            line-height: 2; 
            text-align: left;
            width: 100%; 
            max-height: 75vh; 
            margin-bottom: 30px;
            opacity: 1; 
            transform: translateY(0);
            overflow-y: auto;
            /* éšè—æ»šåŠ¨æ¡ */
            -ms-overflow-style: none;  /* IEã€Edge */
            scrollbar-width: none;     /* Firefox */
        }
        #reward-text-area::-webkit-scrollbar,
        #ending-detail-text-area::-webkit-scrollbar {
            display: none;             /* Chromeã€Safari */
        }
        #reward-content-text,
        #ending-detail-main-text {
            color: var(--text-color);
        }
        
        /* ç« èŠ‚/ç»“å±€å…¨å±é¡µ */
        #chapter-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-base); z-index: 500;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            pointer-events: none; opacity: 0; transition: opacity 1.5s ease;
        }
        #chapter-title {
            font-size: 2.2rem; font-weight: bold; letter-spacing: 5px;
            color: var(--accent-color); text-align: center;
        }

        /* New Game Plus ç•Œé¢æ ·å¼ */
        #ng-plus-screen {
            display: none; 
            background: var(--bg-base);
            z-index: 400;
        }
        #ngp-options {
            max-width: 800px;
            width: 90%;
            text-align: center;
        }
        .ngp-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            background: #fff;
            max-height: 300px;
            overflow-y: auto;
        }
        #ngp-chapter-select {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            max-width: 800px;
            width: 100%;
            margin: 0 auto 30px;
            text-align: left;
        }
        .ngp-option-btn {
            padding: 15px;
            background: #fff;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
            font-family: "Songti SC", "Noto Serif SC", serif;
            font-size: 1.0rem;
            text-align: left;
            line-height: 1.8;
            min-height: 80px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            color: var(--text-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .ngp-option-btn:hover {
            background: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.06);
            transform: translateY(-2px);
        }
        .ngp-option-btn .ach-time {
            font-size: 0.8rem;
            color: #666;
            font-weight: normal;
        }
        .ngp-option-btn .ach-name {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent-color);
        }
        .ngp-option-btn .ach-description {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.4;
        }
        #attr-slider-container {
            margin-top: 15px;
        }
        #attr-slider {
            width: 80%;
            margin: 10px 0;
        }
        #start-ngp-btn {
            margin-top: 30px;
            padding: 12px 40px;
            font-size: 1.2rem;
            border-bottom: 3px solid var(--accent-color);
        }

        /* ä¿®å¤ CSS: ç»“æŸæŒ‰é’® - å¼ºåˆ¶ Flexbox å±…ä¸­ */
        #end-prompt-area {
            position: fixed; 
            bottom: 20%; /* æ”¾åœ¨åˆé€‚çš„é«˜åº¦ */
            left: 0;
            width: 100%;
            
            /* å…³é”®ï¼šä½¿ç”¨ Flexbox å¼ºåˆ¶æ°´å¹³å±…ä¸­ */
            display: flex; 
            justify-content: center; 
            align-items: center;

            z-index: 200; 
            opacity: 0; 
            transition: opacity 0.5s; 
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ç©ºç™½åŒºåŸŸ */
        }
        #end-btn {
            pointer-events: auto; /* æŒ‰é’®è‡ªèº«æ¢å¤å¯ç‚¹å‡» */
            display: block; /* ç¡®ä¿æ˜¯å—çº§å…ƒç´  */
            min-width: 120px;
        }

        /* åŠ¨ç”» */
        @keyframes blink { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 
            10%, 90% { transform: translate3d(-1px, 0, 0); } 
            20%, 80% { transform: translate3d(2px, 0, 0); } 
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 
            40%, 60% { transform: translate3d(4px, 0, 0); } 
        }

        @media (max-width: 600px) {
            .title-main { font-size: 3.5rem; letter-spacing: -2px; }
            .title-sub { font-size: 0.9rem; letter-spacing: 0.5rem; margin-left: 0.2rem; }
            #text-area { font-size: 1.1rem; line-height: 1.8; }
            #control-bar { padding: 10px; gap: 10px; }
            .control-btn { font-size: 0.7rem; padding: 5px 10px; }
            #time-display { font-size: 1.2rem; letter-spacing: 1px; max-width: 95%; }
            .time-char { white-space: nowrap; }
        }
    </style>
</head>
<body>

    <div id="vignette-overlay"></div>
    <div id="noise"></div>

    <div id="top-ui">
        <div id="time-display" style="display:none;">
            <span id="time-text"></span>
        </div>
        <div id="time-heat-container">
            <div id="heat-display">
                <span id="var-name">æ•°å€¼</span>
                <div id="heat-bar-bg"><div id="heat-bar-fill"></div></div>
                <span id="heat-num">0%</span>
            </div>
        </div>
        <div id="timeline-container">
            <span>START</span>
            <div id="timeline-bar"><div id="timeline-progress"></div></div>
            <span>END</span>
        </div>
    </div>

    <div id="control-bar">
        <button class="control-btn" onclick="returnToTitle()">ä¸»é¡µ</button>
        <button class="control-btn" onclick="loadPrevChoice()" id="rewind-btn">æ’¤å›<span class="shortcut-hint">(â†)</span></button>
        <button class="control-btn" onclick="skipToNextChoice()" id="skip-btn">è·³è¿‡<span class="shortcut-hint">(â†’)</span></button>
    </div>

    <div id="chapter-screen">
        <div id="chapter-title"></div>
    </div>

    <div id="start-screen">
        <div class="title-container">
            <h1 class="title-main" id="main-title">AVG ENGINE</h1>
            <div class="title-sub" id="sub-title">è¯·å¯¼å…¥å‰§æœ¬</div>
        </div>
        <div class="credits" id="credits-text">é€šç”¨æ–‡å­—å†’é™©æ¸¸æˆæ’­æ”¾å™¨</div>
        
        <div id="loading-hint" style="display:none; color:#999; font-size:0.9rem; margin:20px 0;">æ­£åœ¨åŠ è½½ libretto.json...</div>
        <div id="error-hint" style="display:none; color:#d93025; font-size:0.9rem; margin:20px 0; max-width:500px; text-align:center;">æœªæ‰¾åˆ° libretto.json æ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®å¯¼å…¥å‰§æœ¬</div>
        <input type="file" id="file-input" accept=".json" onchange="handleFileUpload(this)">
        <button class="menu-btn" id="import-btn" onclick="document.getElementById('file-input').click()" style="border-color: #666; color: #666;">ğŸ“‚ å¯¼å…¥å‰§æœ¬ (JSON)</button>

        <div id="game-controls" style="display:none;">
            <button id="continue-btn" class="menu-btn" onclick="continueGame()" style="display:none;">ç»§ç»­æ¸¸æˆ</button>
            <button class="menu-btn" onclick="normalStart()">å¼€å§‹æ–°æ•…äº‹</button>
            <button id="ngp-btn" class="menu-btn" onclick="showNewGamePlusScreen()" style="display:none;">å¤šå‘¨ç›®æ¨¡å¼</button>
            <button class="menu-btn" onclick="showAchievements()">ç»“å±€åˆ—è¡¨</button>
            <button class="menu-btn" onclick="showSegmentAchievements()">æˆå°±</button>
            <button id="wipe-btn" class="menu-btn danger-btn" onclick="wipeMemory()" style="display:none;">è®°å¿†æ¶ˆé™¤</button>
        </div>
    </div>
    
    <div id="ng-plus-screen">
        <h2 style="margin-bottom: 30px; letter-spacing: 3px;">é€‰æ‹©èµ·å§‹ç« èŠ‚</h2>
        <div id="ngp-options">
            <div class="ngp-section">
                <div id="ngp-chapter-select">
                    </div>
            </div>
            
            <div class="ngp-section" style="max-height: none; overflow: visible; display: none;">
                <h3>è°ƒæ•´åˆå§‹ <span id="ngp-var-name"></span></h3>
                <div id="attr-slider-container">
                    <input type="range" id="attr-slider" min="0" max="100" value="80" oninput="document.getElementById('attr-slider-value').textContent=this.value">
                    <div><span id="attr-slider-value">80</span></div>
                </div>
            </div>
            <button class="menu-btn danger-btn" onclick="hideNewGamePlusScreen()">è¿”å›ä¸»é¡µ</button>
        </div>
    </div>

    <div id="achievement-screen" style="display: none;">
        <h2 style="margin-bottom: 30px; letter-spacing: 3px;">å·²è§£é”ç»“å±€</h2>
        <div class="achievement-list" id="ach-grid"></div>
        <button class="menu-btn" onclick="hideAchievements()">è¿”å›</button>
    </div>

    <div id="segment-achievement-screen" style="display: none;">
        <h2 style="margin-bottom: 30px; letter-spacing: 3px;">æˆå°±</h2>
        <div id="segment-ach-stats" style="margin-bottom: 20px; font-size: 1rem; color: var(--text-color);"></div>
        <div id="full-achievement-button-container" style="margin-bottom: 20px; display: none;">
            <button class="menu-btn" id="full-achievement-btn" onclick="showFullAchievementRewardText()" style="border-color: var(--accent-color); color: var(--accent-color); font-weight: bold;">æŸ¥çœ‹å…¨æˆå°±å¥–åŠ±</button>
        </div>
        <div class="segment-achievement-list" id="segment-ach-grid"></div>
        <button class="menu-btn" onclick="hideSegmentAchievements()">è¿”å›</button>
    </div>
    
    <div id="full-achievement-reward-screen" style="display: none;">
        <div id="reward-text-area" style="max-width: 700px; width: 90%;">
            <span class="speaker" id="reward-speaker-label" style="display: none;"></span>
            <div id="reward-content-text"></div>
        </div>
        <button class="menu-btn" onclick="hideFullAchievementRewardText()" style="margin-top: 10px;">è¿”å›</button>
    </div>
    
    <div id="ending-detail-screen" style="display: none;">
        <div id="ending-detail-title"></div>
        <div id="ending-detail-text-area" style="max-width: 700px; width: 90%;">
            <div id="ending-detail-main-text"></div>
            <div id="ending-detail-desc-text" class="system-text" style="margin-top: 20px;"></div>
        </div>
        <button class="menu-btn" onclick="hideEndingDetail()" style="margin-top: 10px;">è¿”å›</button>
    </div>

    <div id="end-prompt-area">
        <button id="end-btn" class="choice-btn" style="display:none;" onclick="playEndingAnim()">ç»“æŸ</button>
    </div>
    
    <div id="achievement-toast" style="display: none;">
        è¾¾æˆæˆå°±ï¼š<span id="toast-achievement-name"></span>
    </div>
    
    <div id="full-achievement-toast" style="display: none;">
        <span id="full-toast-text"></span>
    </div>

    <div id="game-container" onclick="handleContainerClick()">
        <div id="text-area">
            <span class="speaker" id="speaker-label"></span>
            <div id="content-text"></div>
        </div>
        <div id="continue-hint">ç‚¹å‡»å±å¹•ç»§ç»­</div>
        <div id="choices-area"></div>
    </div>

    <script>
        /**
         * é€šç”¨ AVG å¼•æ“æ ¸å¿ƒé€»è¾‘
         * æ”¯æŒå¯¼å…¥ç¬¦åˆç‰¹å®šç»“æ„çš„ JSON æ–‡ä»¶è¿›è¡Œæ¸¸æˆ
         */

        // --- æ ¸å¿ƒå˜é‡ ---
        let storyData = null; // å­˜å‚¨åŠ è½½çš„ JSON
        let gameState = { 
            nodeId: "", 
            val: 0, // é€šç”¨æ•°å€¼ (åŸç‡¥çƒ­å€¼)
            flags: [], 
            segmentIndex: 0, 
            progress: 0,
            time: "" // å½“å‰æ—¶é—´èŠ‚ç‚¹
        };
        let gameHistory = [];
        let unlockedAchievements = [];
        let unlockedSegmentAchievements = [];
        let storageKeyPrefix = "avg_engine_"; 
        let inputEnabled = true; 
        
        // NG+ å˜é‡
        let finalEndings = []; // è‡ªåŠ¨ç­›é€‰å‡ºçš„æµç¨‹è¾ƒé•¿çš„ç»“å±€
        let ngpSettings = {
            startNodeId: null,
            initialVal: 50
        };

        // æ–°å¢ï¼šRGBè½¬äº®åº¦å…¬å¼ (ITU-R BT.709)
        function getLuminance(hex) {
            // ç§»é™¤ #
            hex = hex.replace('#', '');
            // åˆ†å‰² RGB
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            // è®¡ç®—äº®åº¦ (åŠ æƒå¹³å‡)
            return (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
        }

        // è¾…åŠ©å‡½æ•°: å¯ç”¨æˆ–ç¦ç”¨åº•éƒ¨æ§åˆ¶æŒ‰é’®
        function setControlsEnabled(enabled) {
            document.getElementById('rewind-btn').disabled = !enabled;
            document.getElementById('skip-btn').disabled = !enabled;
        }


        // --- æ–‡ä»¶å¤„ç†ä¸åˆå§‹åŒ– ---
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å°è¯•åŠ è½½ libretto.json
        window.addEventListener('DOMContentLoaded', function() {
            const loadingHint = document.getElementById('loading-hint');
            const errorHint = document.getElementById('error-hint');
            const importBtn = document.getElementById('import-btn');
            
            // å°è¯•è‡ªåŠ¨åŠ è½½ libretto.json
            loadingHint.style.display = 'block';
            fetch('libretto.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('File not found');
                    }
                    return response.json();
                })
                .then(json => {
                    loadingHint.style.display = 'none';
                    errorHint.style.display = 'none';
                    importBtn.style.display = 'none';
                    loadStory(json);
                })
                .catch(err => {
                    loadingHint.style.display = 'none';
                    errorHint.style.display = 'block';
                    importBtn.style.display = 'block';
                    console.log('è‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¯¼å…¥:', err);
                });
        });

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    document.getElementById('loading-hint').style.display = 'none';
                    document.getElementById('error-hint').style.display = 'none';
                    document.getElementById('import-btn').style.display = 'none';
                    loadStory(json);
                } catch (err) {
                    alert("JSON è§£æå¤±è´¥: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function loadStory(json) {
            // åŸºç¡€æ ¡éªŒ
            if (!json.nodes || !json.startNodeId) {
                alert("æ— æ•ˆçš„å‰§æœ¬æ–‡ä»¶ï¼šç¼ºå°‘ nodes æˆ– startNodeId");
                return;
            }

            storyData = json;
            const root = document.documentElement;
            
            // 1. åº”ç”¨å…ƒæ•°æ® (Title, Style)
            document.getElementById('main-title').textContent = json.meta.title || "æœªçŸ¥æ•…äº‹";
            document.getElementById('sub-title').textContent = json.meta.subtitle || "UNKNOWN STORY";
            document.getElementById('credits-text').textContent = "ä½œè€…: " + (json.meta.author || "ä½šå");
            
            // 2. åº”ç”¨ä¸»é¢˜é¢œè‰² & è‡ªåŠ¨é€‚é…æ–‡æœ¬è‰²
            let bgBaseColor = '#f5f5f5'; // é»˜è®¤å€¼
            if (json.meta.theme) {
                if(json.meta.theme.bgBase) {
                    bgBaseColor = json.meta.theme.bgBase;
                    root.style.setProperty('--bg-base', bgBaseColor);
                }
                if(json.meta.theme.bgIntense) root.style.setProperty('--bg-hot', json.meta.theme.bgIntense);
                if(json.meta.theme.textColor) {
                    root.style.setProperty('--text-color', json.meta.theme.textColor);
                }
                if(json.meta.theme.accentColor) root.style.setProperty('--accent-color', json.meta.theme.accentColor);
                if(json.meta.theme.barColor) root.style.setProperty('--heat-color', json.meta.theme.barColor);
            }
            
            if (!json.meta.theme || !json.meta.theme.textColor) {
                const luminance = getLuminance(bgBaseColor);
                if (luminance < 0.5) {
                    root.style.setProperty('--text-color', '#f0f0f0'); 
                    if(!json.meta.theme.accentColor) root.style.setProperty('--accent-color', '#cccccc'); 
                    if(!json.meta.theme.barColor) root.style.setProperty('--heat-color', '#dddddd'); 
                } else {
                    root.style.setProperty('--text-color', '#1a1a1a');
                    if(!json.meta.theme.accentColor) root.style.setProperty('--accent-color', '#333333'); 
                    if(!json.meta.theme.barColor) root.style.setProperty('--heat-color', '#555555'); 
                }
            }

            // 3. åº”ç”¨æ•°å€¼åç§°
            document.getElementById('var-name').textContent = json.meta.variableName || "ï¼Ÿï¼Ÿï¼Ÿ";
            document.getElementById('ngp-var-name').textContent = document.getElementById('var-name').textContent;
            
            // 4. åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
            if (json.meta.initialTime) {
                gameState.time = json.meta.initialTime;
                document.getElementById('time-display').style.display = 'block';
                updateTimeDisplay();
            }
            
            // 5. ç¡®å®šå­˜æ¡£ Key
            storageKeyPrefix = `avg_${json.meta.title}_`;
            
            // 5. è‡ªåŠ¨è¯†åˆ«æµç¨‹è¾ƒé•¿çš„æœ€ç»ˆç»“å±€
            identifyFinalEndings();

            // 6. åŠ è½½å­˜æ¡£çŠ¶æ€
            checkSaves();

            // 7. æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
            document.getElementById('game-controls').style.display = 'block';
            
            // éšè—æ–‡ä»¶è¾“å…¥æŒ‰é’®
            document.getElementById('import-btn').style.display = 'none';
        }
        
        // è‡ªåŠ¨è¯†åˆ«æµç¨‹è¾ƒé•¿çš„æœ€ç»ˆç»“å±€
        function identifyFinalEndings() {
            finalEndings = [];
            const allEndings = [];
            
            // 1. æ”¶é›†æ‰€æœ‰ç»“å±€åŠå…¶è¿›åº¦å€¼
            for (const nodeId in storyData.nodes) {
                const node = storyData.nodes[nodeId];
                if (node.isEnding && node.progress !== undefined) {
                    allEndings.push({ 
                        title: node.title, 
                        progress: node.progress,
                        id: nodeId
                    });
                }
            }
            
            if (allEndings.length === 0) return;

            // 2. æŒ‰è¿›åº¦å€¼é™åºæ’åº
            allEndings.sort((a, b) => b.progress - a.progress);

            // 3. é€‰æ‹©è¿›åº¦æœ€é«˜çš„ï¼ˆè‡³å°‘è¾¾åˆ°80%çš„ï¼‰ä½œä¸ºâ€œæœ€ç»ˆç»“å±€â€
            const minProgressForFinal = 80;
            finalEndings = allEndings.filter(e => e.progress >= minProgressForFinal);
            
            // å¦‚æœæ²¡æœ‰è¾¾åˆ°80%çš„ç»“å±€ï¼Œåˆ™å–è¿›åº¦æœ€é«˜çš„3ä¸ª
            if (finalEndings.length === 0) {
                 finalEndings = allEndings.slice(0, 3);
            }
        }

        // æ–°å¢ï¼šè®°å½•å·²è®¿é—®è¿‡çš„æœ‰å¼€åœºåŠ¨ç”»çš„ç« èŠ‚
        function recordVisitedChapter(nodeId) {
            let visited = JSON.parse(localStorage.getItem(storageKeyPrefix + 'visitedChapters') || '[]');
            if (!visited.includes(nodeId)) {
                visited.push(nodeId);
                localStorage.setItem(storageKeyPrefix + 'visitedChapters', JSON.stringify(visited));
            }
        }

        function checkSaves() {
            // åŠ è½½æˆå°±
            const achStr = localStorage.getItem(storageKeyPrefix + 'achievements');
            unlockedAchievements = achStr ? JSON.parse(achStr) : [];
            
            // åŠ è½½segmentæˆå°±
            const segmentAchStr = localStorage.getItem(storageKeyPrefix + 'segmentAchievements');
            unlockedSegmentAchievements = segmentAchStr ? JSON.parse(segmentAchStr) : [];
            
            // æ£€æŸ¥å¤šå‘¨ç›®è§£é”æ¡ä»¶
            const hasUnlockedFinalEnding = unlockedAchievements.some(ach => {
                return finalEndings.some(fe => fe.title === ach.title);
            });
            
            if (hasUnlockedFinalEnding) {
                document.getElementById('ngp-btn').style.display = 'block';
                setupNewGamePlusScreen(); 
            } else {
                document.getElementById('ngp-btn').style.display = 'none';
            }


            // æ£€æŸ¥è¿›åº¦å­˜æ¡£
            if (localStorage.getItem(storageKeyPrefix + 'save')) {
                document.getElementById('continue-btn').style.display = 'block';
            } else {
                document.getElementById('continue-btn').style.display = 'none';
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºé‡ç½®æŒ‰é’® (å¦‚æœæœ‰æˆå°±æˆ–å­˜æ¡£)
            if (unlockedAchievements.length > 0 || localStorage.getItem(storageKeyPrefix + 'save')) {
                document.getElementById('wipe-btn').style.display = 'block';
            } else {
                document.getElementById('wipe-btn').style.display = 'none';
            }
        }
        
        // ä¿®å¤: NGPç•Œé¢è®¾ç½® (åŸºäºå·²æ’­æ”¾è®°å½•)
        function setupNewGamePlusScreen() {
            const selectArea = document.getElementById('ngp-chapter-select');
            selectArea.innerHTML = '';
            
            // 1. è·å–å†å²è®°å½•
            const visited = JSON.parse(localStorage.getItem(storageKeyPrefix + 'visitedChapters') || '[]');
            const availableStarts = [];

            // 2. å§‹ç»ˆåŒ…å«æ¸¸æˆæœ€åˆå§‹èŠ‚ç‚¹ (ä¸ä¾èµ–è¿›åº¦ï¼Œç¡®ä¿æœ‰é€‰é¡¹)
            const startNode = storyData.nodes[storyData.startNodeId];
            const startNodeName = (startNode && (startNode.name || startNode.chapterTitle)) || "å¼€å§‹æ¸¸æˆ";
            const startNodeTime = (startNode && startNode.time) || "??æœˆ??æ—¥ ??ï¼š??";
            const startNodeVal = (startNode && startNode.initialVariable !== undefined) ? startNode.initialVariable : (storyData.meta && storyData.meta.initialVariable) || 80;

            availableStarts.push({
                name: startNodeName,
                nodeId: storyData.startNodeId,
                time: startNodeTime,
                val: startNodeVal,
                progress: (startNode && startNode.progress) ? startNode.progress : 0
            });

            // 3. éå†å†å²è®°å½•ï¼Œæ·»åŠ å·²è§£é”ç« èŠ‚
            visited.forEach(nodeId => {
                // æ’é™¤ startNodeId (é¿å…é‡å¤)
                if (nodeId === storyData.startNodeId) return;

                const node = storyData.nodes[nodeId];
                if (node) {
                    const nodeName = (node.name || node.chapterTitle || nodeId);
                    const nodeTime = node.time || "??æœˆ??æ—¥ ??ï¼š??";
                    const nodeVal = (node.initialVariable !== undefined) ? node.initialVariable : (storyData.meta && storyData.meta.initialVariable) || 80;
                    
                    availableStarts.push({
                        name: nodeName,
                        nodeId: nodeId,
                        time: nodeTime,
                        val: nodeVal,
                        progress: node.progress || 0
                    });
                }
            });

            // 4. æŒ‰èŠ‚ç‚¹è¿›åº¦æ’åº (è¾…åŠ©æ’åºï¼Œéå¼ºåˆ¶å…³è”)
            availableStarts.sort((a, b) => a.progress - b.progress);

            // 5. æ¸²æŸ“æŒ‰é’®
            if (availableStarts.length > 0) {
                ngpSettings.startNodeId = availableStarts[0].nodeId; // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
            }
            ngpSettings.initialVal = 80;

            availableStarts.forEach(start => {
                const btn = document.createElement('button');
                btn.className = 'ngp-option-btn';
                // ä½¿ç”¨innerHTMLæ¥æ”¯æŒHTMLæ ¼å¼ï¼Œå¹¶å¤ç”¨æˆå°±æ ·å¼
                btn.innerHTML = `
                    <div class="ach-name">${start.name}</div>
                    <div class="ach-time">${start.time}</div>
                    <div class="ach-description">å‹‡æ°”: ${start.val}</div>
                `;
                btn.dataset.nodeId = start.nodeId;
                btn.onclick = () => {
                    const selectedNode = storyData.nodes[start.nodeId];
                    const initialVal = (selectedNode && selectedNode.initialVariable !== undefined) 
                        ? selectedNode.initialVariable 
                        : (storyData.meta.initialVariable || 0);
                
                    // ç›´æ¥ä»è¯¥ç« èŠ‚å¼€å§‹å¤šå‘¨ç›®
                    startGame(start.nodeId, initialVal);
                    document.getElementById('ng-plus-screen').style.display = 'none';
                };
                
                selectArea.appendChild(btn);
            });
            
            // 6. è®¾ç½®åˆå§‹å±æ€§æ»‘å—ï¼ˆå·²éšè—ï¼Œä¸å†éœ€è¦è®¾ç½®ï¼‰
            // document.getElementById('attr-slider').value = ngpSettings.initialVal;
            // document.getElementById('attr-slider-value').textContent = ngpSettings.initialVal;
        }
        
        function showNewGamePlusScreen() {
             document.getElementById('start-screen').style.display = 'none';
             document.getElementById('ng-plus-screen').style.display = 'flex';
        }
        
        function hideNewGamePlusScreen() {
             document.getElementById('ng-plus-screen').style.display = 'none';
             document.getElementById('start-screen').style.display = 'flex';
        }
        
        function startNewGamePlus() {
            const startNodeId = ngpSettings.startNodeId;
            
            if (!startNodeId) {
                alert("è¯·é€‰æ‹©ä¸€ä¸ªèµ·å§‹ç« èŠ‚ã€‚");
                return;
            }
            
            // ä½¿ç”¨é€‰ä¸­èŠ‚ç‚¹çš„initialVariableå€¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨metaä¸­çš„initialVariable
            const selectedNode = storyData.nodes[startNodeId];
            const initialVal = (selectedNode && selectedNode.initialVariable !== undefined) 
                ? selectedNode.initialVariable 
                : (storyData.meta.initialVariable || 0);
            
            // å¼€å§‹ NGP æ¸¸æˆ
            startGame(startNodeId, initialVal);
            document.getElementById('ng-plus-screen').style.display = 'none';
        }

        // --- æ¸¸æˆæµç¨‹æ§åˆ¶ ---

        function normalStart() {
            if (!storyData) return;
            startGame(storyData.startNodeId, storyData.meta.initialVariable || 0);
        }

        function startGame(startNodeId, initialVal) {
            gameState = { 
                nodeId: startNodeId, 
                val: initialVal, 
                flags: [], 
                segmentIndex: 0, 
                progress: 0,
                time: storyData.meta.initialTime || ""
            };
            gameHistory = [];
            
            // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
            if (gameState.time) {
                document.getElementById('time-display').style.display = 'block';
                updateTimeDisplay();
            } 
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('top-ui').style.opacity = '1';
            document.getElementById('control-bar').style.opacity = '1';
            document.getElementById('control-bar').style.pointerEvents = 'auto';
            
            inputEnabled = true; 
            setControlsEnabled(true); 

            // éšè—ç»“å±€æŒ‰é’®
            document.getElementById('end-btn').style.display = 'none'; 
            document.getElementById('end-prompt-area').style.opacity = '0';
            
            updateStatusUI();
            processNode(startNodeId);
        }

        function continueGame() {
            const saveStr = localStorage.getItem(storageKeyPrefix + 'save');
            if (saveStr) {
                const save = JSON.parse(saveStr);
                gameState = save.gameState;
                gameHistory = save.gameHistory || [];
                
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('top-ui').style.opacity = '1';
                document.getElementById('control-bar').style.opacity = '1';
                document.getElementById('control-bar').style.pointerEvents = 'auto';

                inputEnabled = true; 
                setControlsEnabled(true); 

                // éšè—ç»“å±€æŒ‰é’®
                document.getElementById('end-btn').style.display = 'none';
                document.getElementById('end-prompt-area').style.opacity = '0';
                
                updateStatusUI();
                
                // æ¢å¤æ—¶é—´æ˜¾ç¤º
                if (gameState.time) {
                    document.getElementById('time-display').style.display = 'block';
                    updateTimeDisplay();
                }
                
                // æ¢å¤åˆ°å½“å‰èŠ‚ç‚¹ï¼Œä¸å†æ¬¡ä¿å­˜å†å²
                processNode(gameState.nodeId, true);
            }
        }

        function autoSave() {
            if (!storyData) return;
            const saveObj = {
                gameState: gameState,
                gameHistory: gameHistory
            };
            localStorage.setItem(storageKeyPrefix + 'save', JSON.stringify(saveObj));
        }

        // æ ¸å¿ƒé€»è¾‘è§£æå™¨
        function processNode(nodeId, isBacktracking = false) {
            if (!storyData.nodes[nodeId]) {
                alert("é”™è¯¯ï¼šèŠ‚ç‚¹ä¸å­˜åœ¨ " + nodeId);
                return;
            }

            gameState.nodeId = nodeId;
            gameState.segmentIndex = 0;
            
            if (!isBacktracking) autoSave();

            const node = storyData.nodes[nodeId];

            // æ›´æ–°è¿›åº¦æ¡
            if (node.progress !== undefined) {
                gameState.progress = node.progress;
                document.getElementById('timeline-progress').style.width = gameState.progress + '%';
            }

            // æ›´æ–°æ—¶é—´
            if (node.time !== undefined) {
                gameState.time = node.time;
                updateTimeDisplay();
            }

            // 1. è‡ªåŠ¨é€»è¾‘è·¯ç”± (Automatic Routes)
            if (node.routes) {
                for (let route of node.routes) {
                    if (checkCondition(route.condition)) {
                        processNode(route.next, isBacktracking);
                        return;
                    }
                }
                return; 
            }

            // 2. ç»“å±€å¤„ç†
            if (node.isEnding) {
                showEndingPhase(node);
                localStorage.removeItem(storageKeyPrefix + 'save'); 
                return;
            }

            // 3. ç« èŠ‚è½¬åœº
            if (node.chapterTitle) {
                showChapterTitle(node.chapterTitle, () => renderSegment());
            } else {
                renderSegment();
            }
        }

        // ç®€å•çš„æ¡ä»¶è§£æå™¨
        function checkCondition(condStr) {
            if (condStr === 'default') return true;
            
            // æ£€æŸ¥æ•°å€¼
            if (condStr.includes('val')) {
                let operator = condStr.match(/>=|<=|>|<|==/)[0];
                let targetVal = parseInt(condStr.split(operator)[1].trim());
                let currentVal = gameState.val;
                
                if (operator === '>=') return currentVal >= targetVal;
                if (operator === '<=') return currentVal <= targetVal;
                if (operator === '>') return currentVal > targetVal;
                if (operator === '<') return currentVal < targetVal;
                if (operator === '==') return currentVal == targetVal;
            }

            // æ£€æŸ¥ Flag
            if (condStr.includes('hasFlag')) {
                let flagName = condStr.match(/'([^']+)'/)[1];
                let hasIt = gameState.flags.includes(flagName);
                if (condStr.startsWith('!')) return !hasIt;
                return hasIt;
            }

            return false;
        }

        function renderSegment() {
            const node = storyData.nodes[gameState.nodeId];
            
            // å¦‚æœæ’­æ”¾å®Œäº†æ‰€æœ‰æ®µè½
            if (!node.segments || gameState.segmentIndex >= node.segments.length) {
                document.getElementById('continue-hint').style.display = 'none';
                // æ˜¾ç¤ºé€‰é¡¹æˆ–ç›´æ¥è·³è½¬
                if (node.choices) {
                    renderChoices(node.choices);
                } else if (node.next) {
                    processNode(node.next);
                }
                return;
            }

            const segment = node.segments[gameState.segmentIndex];
            const textArea = document.getElementById('text-area');
            const contentText = document.getElementById('content-text');
            const speakerLabel = document.getElementById('speaker-label');

            // æ·¡å…¥æ·¡å‡ºæ•ˆæœ
            textArea.style.opacity = '0';
            textArea.style.transform = 'translateY(10px)';

            setTimeout(() => {
                // æ›´æ–°æ—¶é—´ï¼ˆå¦‚æœsegmentä¸­å®šä¹‰äº†timeï¼‰
                if (segment.time !== undefined) {
                    gameState.time = segment.time;
                    updateTimeDisplay();
                }

                // ä¿®æ”¹valå€¼ï¼ˆå¦‚æœsegmentä¸­å®šä¹‰äº†changesï¼‰
                if (segment.changes) {
                    if (segment.changes.val) gameState.val += segment.changes.val;
                    if (segment.changes.valSet !== undefined) gameState.val = segment.changes.valSet;
                    if (segment.changes.addFlag) gameState.flags.push(segment.changes.addFlag);
                    if (segment.changes.removeFlag) {
                        gameState.flags = gameState.flags.filter(f => f !== segment.changes.removeFlag);
                    }
                    
                    // è¾¹ç•Œæ£€æŸ¥
                    if (gameState.val < 0) gameState.val = 0;
                    if (gameState.val > 100) gameState.val = 100;
                    updateStatusUI();
                }

                // æ¸²æŸ“è¯´è¯è€…
                if (segment.speaker && segment.speaker !== "") {
                    speakerLabel.textContent = segment.speaker;
                    speakerLabel.style.display = "block";
                    // ç‰¹æ®Šç³»ç»Ÿæ–‡æœ¬æ ·å¼
                    if (segment.speaker === "ç³»ç»Ÿ" || segment.speaker === "System") {
                        contentText.innerHTML = `<span class="system-text">${segment.text}</span>`;
                    } else {
                        contentText.innerHTML = segment.text;
                    }
                } else {
                    speakerLabel.style.display = "none";
                    contentText.innerHTML = segment.text;
                }

                // è§¦å‘è§†è§‰ç‰¹æ•ˆ
                if (segment.effect) handleEffects(segment.effect);
                
                // æ£€æµ‹å¹¶è§£é”æˆå°±
                if (segment.achievement) {
                    const achievement = segment.achievement;
                    // æ£€æŸ¥æ˜¯å¦å·²è§£é”ï¼ˆé€šè¿‡æˆå°±ååˆ¤æ–­ï¼‰
                    if (!unlockedSegmentAchievements.some(a => a.name === achievement.name)) {
                        // æ·»åŠ æˆå°±
                        unlockedSegmentAchievements.push({
                            time: achievement.time || segment.time || "",
                            name: achievement.name,
                            description: achievement.description || ""
                        });
                        // ä¿å­˜åˆ°localStorage
                        localStorage.setItem(storageKeyPrefix + 'segmentAchievements', JSON.stringify(unlockedSegmentAchievements));
                        // æ˜¾ç¤ºå¼¹çª—æç¤º
                        showAchievementToast(achievement);
                        
                        // æ£€æµ‹æ˜¯å¦å…¨æˆå°±è§£é”
                        let totalAchievements = 0;
                        if (storyData && storyData.nodes) {
                            for (const nodeId in storyData.nodes) {
                                const node = storyData.nodes[nodeId];
                                if (node.segments) {
                                    for (const seg of node.segments) {
                                        if (seg.achievement) {
                                            totalAchievements++;
                                        }
                                    }
                                }
                            }
                        }
                        const unlockedCount = unlockedSegmentAchievements.length;
                        if (unlockedCount === totalAchievements && totalAchievements > 0) {
                            // å…¨æˆå°±è§£é”ï¼Œæ˜¾ç¤ºå…¨æˆå°±å¼¹çª—
                            showFullAchievementReward();
                        }
                    }
                }
                
                textArea.style.opacity = '1';
                textArea.style.transform = 'translateY(0)';
                document.getElementById('continue-hint').style.display = 'block';
            }, 200);
        }

        function handleEffects(effect) {
            const container = document.getElementById('game-container');
            container.classList.remove('shake');
            document.body.style.filter = "none";

            if (effect === 'shake') {
                container.classList.add('shake');
                if("vibrate" in navigator) navigator.vibrate(200);
            } else if (effect === 'blur') {
                document.body.style.filter = "blur(2px)";
                setTimeout(() => document.body.style.filter = "none", 2000);
            }
        }

        function renderChoices(choices) {
            const choicesArea = document.getElementById('choices-area');
            choicesArea.innerHTML = '';
            choicesArea.style.opacity = '0';
            choicesArea.style.pointerEvents = 'auto';
            
            // å­˜å…¥å†å²æ ˆä»¥ä¾¿æ’¤å›
            const savedState = JSON.parse(JSON.stringify(gameState));
            if (gameHistory.length === 0 || gameHistory[gameHistory.length-1].nodeId !== savedState.nodeId) {
                gameHistory.push(savedState);
            }
            autoSave();

            choices.forEach(choice => {
                // æ£€æŸ¥é€‰é¡¹æ˜¯å¦å¯è§ (å¯é€‰åŠŸèƒ½)
                if (choice.condition && !checkCondition(choice.condition)) return;

                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice.text;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    makeChoice(choice);
                };
                choicesArea.appendChild(btn);
            });

            setTimeout(() => choicesArea.style.opacity = '1', 200);
        }

        function makeChoice(choice) {
            document.getElementById('choices-area').style.opacity = '0';
            document.getElementById('choices-area').style.pointerEvents = 'none';

            // åº”ç”¨æ•ˆæœ
            if (choice.changes) {
                if (choice.changes.val) gameState.val += choice.changes.val;
                if (choice.changes.valSet !== undefined) gameState.val = choice.changes.valSet;
                if (choice.changes.addFlag) gameState.flags.push(choice.changes.addFlag);
                if (choice.changes.removeFlag) {
                    gameState.flags = gameState.flags.filter(f => f !== choice.changes.removeFlag);
                }
                
                // è¾¹ç•Œæ£€æŸ¥
                if (gameState.val < 0) gameState.val = 0;
                if (gameState.val > 100) gameState.val = 100;
                updateStatusUI();
            }

            processNode(choice.next);
        }

        // --- UI æ›´æ–° ---

        let previousTime = '';
        
        function updateTimeDisplay() {
            const timeDisplay = document.getElementById('time-display');
            const timeText = document.getElementById('time-text');
            
            if (!gameState.time) {
                timeDisplay.style.display = 'none';
                previousTime = '';
                return;
            }
            
            timeDisplay.style.display = 'flex';
            const currentTime = gameState.time;
            
            // å¦‚æœæ—¶é—´æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›ï¼ˆä¸é‡æ–°æ¸²æŸ“ï¼‰
            if (currentTime === previousTime) {
                return;
            }
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            timeText.innerHTML = '';
            
            // å°†æ—¶é—´å­—ç¬¦ä¸²æ‹†åˆ†æˆå­—ç¬¦
            const chars = currentTime.split('');
            const prevChars = previousTime ? previousTime.split('') : [];
            
            // ä¸ºæ¯ä¸ªå­—ç¬¦åˆ›å»ºspanå…ƒç´ 
            chars.forEach((char, index) => {
                const charSpan = document.createElement('span');
                charSpan.className = 'time-char';
                
                const charInner = document.createElement('span');
                charInner.className = 'time-char-inner';
                charInner.textContent = char;
                
                // å¦‚æœå­—ç¬¦å‘ç”Ÿå˜åŒ–ä¸”æ˜¯æ•°å­—ï¼Œæ·»åŠ åŠ¨ç”»ç±»
                if (previousTime && prevChars[index] !== char && /[0-9]/.test(char)) {
                    // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMå·²æ›´æ–°
                    requestAnimationFrame(() => {
                        charSpan.classList.add('animate');
                        // åŠ¨ç”»ç»“æŸåç§»é™¤ç±»
                        setTimeout(() => {
                            charSpan.classList.remove('animate');
                        }, 500);
                    });
                }
                
                charSpan.appendChild(charInner);
                timeText.appendChild(charSpan);
            });
            
            previousTime = currentTime;
        }

        function updateStatusUI() {
            const fill = document.getElementById('heat-bar-fill');
            const num = document.getElementById('heat-num');
            const vignette = document.getElementById('vignette-overlay');
            
            fill.style.width = gameState.val + '%';
            num.textContent = gameState.val + '%';
            
            // åŠ¨æ€è§†è§‰åé¦ˆ (æ ¹æ®æ•°å€¼æ”¹å˜èƒŒæ™¯å¼ºåº¦)
            const intensity = gameState.val / 100;
            // æ¨¡æ‹Ÿçƒ­æµª/å‹åŠ›æš—è§’
            vignette.style.boxShadow = `inset 0 0 ${50 + intensity * 150}px rgba(0,0,0, ${0.1 + intensity * 0.4})`;
            
            // å¦‚æœæ˜¯é«˜æ•°å€¼ï¼ŒèƒŒæ™¯åˆ‡æ¢åˆ° intense é¢œè‰²
            if (intensity > 0.5) {
                document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-hot');
            } else {
                document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--bg-base');
            }
        }

        function showChapterTitle(title, callback) {
            inputEnabled = false; 
            setControlsEnabled(false); 

            // å…³é”®é€»è¾‘ï¼šåœ¨æ­¤å¤„è®°å½•å·²æ’­æ”¾çš„ç« èŠ‚
            recordVisitedChapter(gameState.nodeId);

            const screen = document.getElementById('chapter-screen');
            const titleEl = document.getElementById('chapter-title');
            titleEl.textContent = title;
            titleEl.style.color = "var(--accent-color)";
            screen.style.opacity = '1';

            setTimeout(() => {
                screen.style.opacity = '0';
                setTimeout(() => {
                    inputEnabled = true; 
                    setControlsEnabled(true); 
                    callback();
                }, 1000);
            }, 2500);
        }

        function showEndingPhase(node) {
            document.getElementById('control-bar').style.opacity = '0';
            document.getElementById('control-bar').style.pointerEvents = 'none';

            // è§£é”æˆå°±
            if (!unlockedAchievements.some(a => a.title === node.title)) {
                const endingId = node.id || gameState.nodeId; // ä½¿ç”¨å½“å‰èŠ‚ç‚¹IDä½œä¸ºç»“å±€ID
                unlockedAchievements.push({ 
                    title: node.title, 
                    type: node.type, 
                    desc: node.description,
                    id: endingId
                });
                localStorage.setItem(storageKeyPrefix + 'achievements', JSON.stringify(unlockedAchievements));
            }

            const textArea = document.getElementById('text-area');
            const choicesArea = document.getElementById('choices-area');

            textArea.style.opacity = '0';
            choicesArea.style.opacity = '0';
            choicesArea.style.pointerEvents = 'none'; 

            setTimeout(() => {
                document.getElementById('speaker-label').style.display = "none";
                document.getElementById('content-text').innerHTML = `<span class="system-text" style="font-size:1.1rem; line-height:1.8;">${node.description}</span>`;
                textArea.style.opacity = '1';
                
                // å¯ç”¨è¾“å…¥ï¼Œè®©â€œç»“æŸâ€æŒ‰é’®å¯ç‚¹å‡»
                inputEnabled = true; 
                
                const endBtn = document.getElementById('end-btn');
                endBtn.textContent = "ç»“æŸ";
                endBtn.onclick = (e) => {
                    e.stopPropagation();
                    playEndingAnim(node.title); 
                };
                endBtn.style.display = 'block';
                document.getElementById('end-prompt-area').style.opacity = '1';

            }, 500);
            
            // è¿›åº¦æ¡æ»¡
            document.getElementById('timeline-progress').style.width = '100%';
        }

        function playEndingAnim(title) {
            inputEnabled = false; 

            document.getElementById('end-prompt-area').style.opacity = '0'; 
            
            const screen = document.getElementById('chapter-screen');
            const titleEl = document.getElementById('chapter-title');
            
            document.getElementById('game-container').style.opacity = '0';
            document.getElementById('top-ui').style.opacity = '0';

            titleEl.innerHTML = title;
            titleEl.style.fontSize = "2.5rem";
            titleEl.style.color = "#000"; 
            
            screen.style.opacity = '1';
            
            // ç»“å±€åè¿”å›å½“å‰æ¸¸æˆä¸»é¡µ
            setTimeout(() => {
                inputEnabled = true; 

                // é‡ç½®æ¸¸æˆç•Œé¢æ˜¾ç¤º
                document.getElementById('game-container').style.opacity = '1';
                // éšè—å…¨å±åŠ¨ç”»
                screen.style.opacity = '0'; 
                // è¿”å›ä¸»é¡µèœå•
                document.getElementById('start-screen').style.display = 'flex';
                // æ£€æŸ¥å­˜æ¡£ï¼Œæ›´æ–°ç»§ç»­æŒ‰é’®çŠ¶æ€å’ŒNGPæŒ‰é’®çŠ¶æ€
                checkSaves(); 
            }, 3500);
        }

        // --- æ‚é¡¹åŠŸèƒ½ ---

        function handleContainerClick() {
            if (!inputEnabled) return; 

            if (!storyData) return;
            const node = storyData.nodes[gameState.nodeId];
            if (document.getElementById('choices-area').style.opacity === '1') return;
            
            // ç»“å±€æ—¶ç‚¹å‡»å±å¹•ä¸å“åº”
            if (node && node.isEnding) return; 
            
            if (node && node.segments && gameState.segmentIndex < node.segments.length) {
                gameState.segmentIndex++;
                renderSegment();
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (!inputEnabled) return; 

            if (document.getElementById('start-screen').style.display !== 'none' || !storyData) return;
            
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') loadPrevChoice();
            else if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') skipToNextChoice();
        });

        function loadPrevChoice() {
            if (!inputEnabled) return; 
            
            if (gameHistory.length > 0) {
                const prevState = gameHistory.pop();
                gameState = JSON.parse(JSON.stringify(prevState));
                
                document.getElementById('choices-area').style.opacity = '0';
                document.getElementById('choices-area').style.pointerEvents = 'none';
                updateStatusUI();
                document.getElementById('timeline-progress').style.width = gameState.progress + '%';
                
                processNode(gameState.nodeId, true);
                autoSave();
            }
        }

        function skipToNextChoice() {
            if (!inputEnabled) return; 
            const node = storyData.nodes[gameState.nodeId];
            if (document.getElementById('choices-area').style.opacity === '1') return;
            if (node.isEnding) return;

            if (node.segments && gameState.segmentIndex < node.segments.length - 1) {
                gameState.segmentIndex = node.segments.length - 1;
                renderSegment();
            } else {
                handleContainerClick();
            }
        }

        function returnToTitle() {
            if (confirm("ç¡®å®šè¦è¿”å›ä¸»é¡µå—ï¼Ÿæ¸¸æˆä¼šè‡ªåŠ¨ä¿å­˜ã€‚")) {
                autoSave();
                
                // éšè—æ¸¸æˆUI
                document.getElementById('top-ui').style.opacity = '0';
                document.getElementById('control-bar').style.opacity = '0';
                
                // æ˜¾ç¤ºä¸»é¡µ
                document.getElementById('start-screen').style.display = 'flex';
                checkSaves(); 
            }
        }

        function wipeMemory() {
            if (confirm("è­¦å‘Šï¼šè¿™å°†åˆ é™¤è¯¥æ¸¸æˆçš„æ‰€æœ‰è¿›åº¦å’Œç»“å±€è®°å½•ã€‚\nç¡®å®šè¦é‡ç½®å—ï¼Ÿ")) {
                localStorage.removeItem(storageKeyPrefix + 'achievements');
                localStorage.removeItem(storageKeyPrefix + 'segmentAchievements');
                localStorage.removeItem(storageKeyPrefix + 'save');
                // æ–°å¢ï¼šæ¸…é™¤ç« èŠ‚å†å²è®°å½•
                localStorage.removeItem(storageKeyPrefix + 'visitedChapters'); 
                location.reload(); 
            }
        }

        // èœå•æ˜¾ç¤ºé€»è¾‘
        function showAchievements() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('achievement-screen').style.display = 'flex';
            const grid = document.getElementById('ach-grid');
            grid.innerHTML = '';
            
            if (unlockedAchievements.length === 0) {
                grid.innerHTML = '<div style="color:#999; text-align:center; grid-column: 1/-1;">æš‚æ— è¾¾æˆç»“å±€</div>';
            } else {
                unlockedAchievements.forEach((ach, index) => {
                    const div = document.createElement('div');
                    div.className = 'ach-item unlocked';
                    div.innerHTML = `<strong>${ach.title}</strong><br><span style="font-size:0.7rem;color:#666">${ach.type}</span>`;
                    div.style.cursor = 'pointer';
                    div.onclick = () => {
                        showEndingDetail(ach);
                    };
                    grid.appendChild(div);
                });
            }
        }

        function hideAchievements() {
            document.getElementById('achievement-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        }
        
        function showEndingDetail(ending) {
            if (!ending || !storyData || !storyData.meta) return;
            
            const screen = document.getElementById('ending-detail-screen');
            const titleEl = document.getElementById('ending-detail-title');
            const mainEl = document.getElementById('ending-detail-main-text');
            const descEl = document.getElementById('ending-detail-desc-text');
            
            // æ ‡é¢˜ï¼šç»“å±€æ ‡é¢˜ï¼Œå±…ä¸­å±•ç¤º
            titleEl.textContent = ending.title || '';
            
            // æ­£æ–‡ï¼šä» meta.endingDetail ä¸­è¯»å–è‡ªå®šä¹‰é•¿æ–‡æœ¬
            const detailMap = storyData.meta.endingDetail || {};
            const detailRaw = ending.id ? (detailMap[ending.id] || '') : '';
            const detailHtml = detailRaw.replace(/\n/g, '<br>');
            mainEl.innerHTML = detailHtml;
            
            // ç»“å°¾ï¼šæ˜¾ç¤ºåŸæœ‰ descriptionï¼Œä½¿ç”¨ system-text é£æ ¼
            const desc = ending.desc || '';
            const descHtml = desc.replace(/\n/g, '<br>');
            descEl.innerHTML = descHtml;
            
            document.getElementById('achievement-screen').style.display = 'none';
            screen.style.display = 'flex';
        }
        
        function hideEndingDetail() {
            document.getElementById('ending-detail-screen').style.display = 'none';
            document.getElementById('achievement-screen').style.display = 'flex';
        }

        // Segmentæˆå°±ç›¸å…³å‡½æ•°
        function showAchievementToast(achievement) {
            const toast = document.getElementById('achievement-toast');
            const nameSpan = document.getElementById('toast-achievement-name');
            
            nameSpan.textContent = achievement.name;
            toast.style.display = 'block';
            
            // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3ç§’åè‡ªåŠ¨æ·¡å‡º
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 3000);
        }

        function showSegmentAchievements() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('segment-achievement-screen').style.display = 'flex';
            
            const grid = document.getElementById('segment-ach-grid');
            const stats = document.getElementById('segment-ach-stats');
            grid.innerHTML = '';
            
            // è®¡ç®—æ€»æˆå°±æ•°
            let totalAchievements = 0;
            if (storyData && storyData.nodes) {
                for (const nodeId in storyData.nodes) {
                    const node = storyData.nodes[nodeId];
                    if (node.segments) {
                        for (const segment of node.segments) {
                            if (segment.achievement) {
                                totalAchievements++;
                            }
                        }
                    }
                }
            }
            
            const unlockedCount = unlockedSegmentAchievements.length;
            stats.textContent = `å·²æ”¶é›†æˆå°±ï¼š${unlockedCount}${totalAchievements > 0 ? `/${totalAchievements}` : '/?'}`;
            
            // æ£€æµ‹æ˜¯å¦å…¨æˆå°±è§£é”
            const isFullAchievement = unlockedCount === totalAchievements && totalAchievements > 0;
            const buttonContainer = document.getElementById('full-achievement-button-container');
            if (isFullAchievement) {
                buttonContainer.style.display = 'block';
            } else {
                buttonContainer.style.display = 'none';
            }
            
            if (unlockedSegmentAchievements.length === 0) {
                grid.innerHTML = '<div style="color:#999; text-align:center; grid-column: 1/-1;">æš‚æ— è¾¾æˆæˆå°±</div>';
            } else {
                // æŒ‰è§£é”æ—¶é—´å€’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                const sortedAchievements = [...unlockedSegmentAchievements].reverse();
                
                sortedAchievements.forEach(ach => {
                    const div = document.createElement('div');
                    div.className = 'segment-ach-item';
                    div.innerHTML = `
                        <div class="ach-time">${ach.time || ''}</div>
                        <div class="ach-name">${ach.name}</div>
                        <div class="ach-description">${ach.description || ''}</div>
                    `;
                    grid.appendChild(div);
                });
            }
        }

        function hideSegmentAchievements() {
            document.getElementById('segment-achievement-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
        }
        
        // å…¨æˆå°±å¥–åŠ±ç›¸å…³å‡½æ•°
        function showFullAchievementReward() {
            if (!storyData || !storyData.meta || !storyData.meta.fullAchievementReward) {
                return;
            }
            
            const toast = document.getElementById('full-achievement-toast');
            const textSpan = document.getElementById('full-toast-text');
            
            const toastText = storyData.meta.fullAchievementReward.toastText || "å…¨æˆå°±è¾¾æˆï¼";
            textSpan.textContent = toastText;
            toast.style.display = 'block';
            
            // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 5ç§’åè‡ªåŠ¨æ·¡å‡ºï¼ˆæ¯”æ™®é€šæˆå°±å¼¹çª—æ›´é•¿ï¼‰
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 500);
            }, 5000);
        }
        
        function showFullAchievementRewardText() {
            if (!storyData || !storyData.meta || !storyData.meta.fullAchievementReward) {
                return;
            }
            
            const rewardText = storyData.meta.fullAchievementReward.text || "";
            const screen = document.getElementById('full-achievement-reward-screen');
            const contentText = document.getElementById('reward-content-text');
            const speakerLabel = document.getElementById('reward-speaker-label');
            
            // éšè—æˆå°±é¡µé¢
            document.getElementById('segment-achievement-screen').style.display = 'none';
            
            // ç›´æ¥ä½¿ç”¨innerHTMLæ˜¾ç¤ºæ–‡æœ¬ï¼Œæ”¯æŒHTMLæ ¼å¼ï¼ˆä¸æ¸¸æˆæµç¨‹ä¸€è‡´ï¼‰
            // æ–‡æœ¬å†…å®¹åº”è¯¥å·²ç»æ˜¯HTMLæ ¼å¼ï¼Œå¯ä»¥ç›´æ¥æ˜¾ç¤º
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>æ ‡ç­¾ä»¥ä¾¿æ­£ç¡®æ˜¾ç¤º
            const formattedText = rewardText.replace(/\n/g, '<br>');
            contentText.innerHTML = formattedText;
            
            // éšè—speakeræ ‡ç­¾ï¼ˆå¥–åŠ±æ–‡æœ¬é€šå¸¸ä¸éœ€è¦speakerï¼‰
            speakerLabel.style.display = "none";
            
            // æ˜¾ç¤ºå¥–åŠ±æ–‡æœ¬ç•Œé¢
            screen.style.display = 'flex';
        }
        
        function hideFullAchievementRewardText() {
            document.getElementById('full-achievement-reward-screen').style.display = 'none';
            document.getElementById('segment-achievement-screen').style.display = 'flex';
        }

    </script>
</body>
</html>